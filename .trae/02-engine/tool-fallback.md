---
name: Tool Fallback Rules
description: 工具调用备选方案 - 失败处理、降级策略、备选工具、组合模式
version: "9.9"
priority: 90
alwaysApply: true
---

# 工具调用备选方案

> **"工具有备，执行无虞。"**

## 一、失败场景分类

### 1.1 文件操作失败

```yaml
文件不存在:
  场景: 读取/编辑不存在的文件
  原因: 路径错误、文件已删除、权限问题
  影响: 任务中断
  
  处理策略:
    1. 检查路径是否正确
    2. 使用Glob搜索相似文件
    3. 询问用户确认路径
    4. 提供创建文件选项

文件权限不足:
  场景: 无读取/写入权限
  原因: 权限设置、文件锁定
  影响: 操作失败
  
  处理策略:
    1. 检查文件权限
    2. 尝试只读模式
    3. 通知用户权限问题
    4. 提供权限修改建议

文件过大:
  场景: 文件超过读取限制
  原因: 大型日志、数据文件
  影响: 内存溢出、超时
  
  处理策略:
    1. 分段读取文件
    2. 使用流式读取
    3. 只读取关键部分
    4. 建议使用专门工具
```

### 1.2 搜索操作失败

```yaml
无搜索结果:
  场景: Grep/Glob搜索无匹配
  原因: 模式错误、路径错误、文件类型不匹配
  影响: 分析不完整
  
  处理策略:
    1. 放宽搜索条件
    2. 尝试相似模式
    3. 扩大搜索范围
    4. 使用模糊匹配

搜索结果过多:
  场景: 匹配结果超过限制
  原因: 模式过于宽泛
  影响: 信息过载
  
  处理策略:
    1. 缩小搜索范围
    2. 添加更多过滤条件
    3. 分页显示结果
    4. 提供结果摘要

搜索超时:
  场景: 搜索耗时过长
  原因: 代码库过大、模式复杂
  影响: 响应延迟
  
  处理策略:
    1. 简化搜索模式
    2. 限制搜索深度
    3. 使用索引搜索
    4. 分批搜索
```

### 1.3 命令执行失败

```yaml
命令不存在:
  场景: 执行不存在的命令
  原因: 命令未安装、路径问题
  影响: 任务失败
  
  处理策略:
    1. 检查命令是否安装
    2. 使用替代命令
    3. 提供安装指南
    4. 使用内置功能

命令超时:
  场景: 命令执行时间过长
  原因: 任务复杂、资源不足
  影响: 响应延迟
  
  处理策略:
    1. 设置合理超时
    2. 后台执行长任务
    3. 分步执行
    4. 提供进度反馈

命令权限错误:
  场景: 命令执行权限不足
  原因: 需要root/管理员权限
  影响: 操作失败
  
  处理策略:
    1. 检查权限要求
    2. 使用sudo(需确认)
    3. 提供替代方案
    4. 通知用户权限需求
```

---

## 二、备选工具矩阵

### 2.1 文件读取备选

| 主工具 | 备选1 | 备选2 | 备选3 |
|-------|-------|-------|-------|
| Read | Grep (查看部分) | RunCommand (cat) | WebFetch (远程文件) |
| 用途 | 读取完整文件 | 搜索文件内容 | 使用系统命令 | 获取远程文件 |

### 2.2 文件搜索备选

| 主工具 | 备选1 | 备选2 | 备选3 |
|-------|-------|-------|-------|
| Grep | Glob + Read | RunCommand (grep) | SearchCodebase |
| 用途 | 内容搜索 | 先找文件再读 | 系统搜索 | 语义搜索 |

### 2.3 文件查找备选

| 主工具 | 备选1 | 备选2 | 备选3 |
|-------|-------|-------|-------|
| Glob | LS | Grep (文件名) | RunCommand (find) |
| 用途 | 模式匹配 | 目录浏览 | 内容推断 | 系统查找 |

---

## 三、降级策略

### 3.1 功能降级

```yaml
完整功能 → 基本功能:
  示例: 代码分析 → 代码浏览
  触发: 分析工具不可用
  效果: 提供基本浏览功能

基本功能 → 只读功能:
  示例: 代码编辑 → 代码查看
  触发: 写入权限不足
  效果: 只提供查看功能

只读功能 → 描述功能:
  示例: 文件查看 → 文件描述
  触发: 文件无法访问
  效果: 提供文件信息描述
```

### 3.2 数据降级

```yaml
实时数据 → 缓存数据:
  示例: 实时API → 缓存结果
  触发: API不可用
  效果: 使用缓存数据

完整数据 → 部分数据:
  示例: 全量分析 → 关键部分
  触发: 数据量过大
  效果: 分析关键部分

详细数据 → 摘要数据:
  示例: 详细报告 → 摘要报告
  触发: 处理时间过长
  效果: 提供摘要信息
```

### 3.3 精度降级

```yaml
精确匹配 → 模糊匹配:
  示例: 精确搜索 → 模糊搜索
  触发: 精确搜索无结果
  效果: 扩大搜索范围

完整分析 → 快速分析:
  示例: 深度分析 → 快速扫描
  触发: 时间限制
  效果: 提供初步结果

全量扫描 → 采样扫描:
  示例: 全部文件 → 部分文件
  触发: 文件过多
  效果: 基于采样分析
```

---

## 四、错误恢复流程

### 4.1 标准恢复流程

```yaml
Step 1: 错误识别
  - 识别错误类型
  - 分析错误原因
  - 评估影响范围

Step 2: 策略选择
  - 选择备选工具
  - 选择降级策略
  - 选择恢复方案

Step 3: 执行恢复
  - 执行备选方案
  - 记录恢复操作
  - 验证恢复结果

Step 4: 结果处理
  - 评估恢复效果
  - 通知用户状态
  - 记录经验教训
```

### 4.2 用户交互

```yaml
需要用户确认的场景:
  - 使用sudo权限
  - 创建/删除文件
  - 安装新软件
  - 修改系统配置

用户通知模板:
  "检测到{工具}执行失败: {原因}
   正在尝试使用备选方案: {备选工具}
   预计影响: {影响描述}
   
   如需其他方案，请告知。"
```

---

## 五、最佳实践

### 5.1 预防措施

```yaml
执行前检查:
  - 检查文件是否存在
  - 检查权限是否足够
  - 检查工具是否可用
  - 检查资源是否充足

执行中监控:
  - 监控执行时间
  - 监控资源使用
  - 监控错误日志
  - 准备备选方案
```

### 5.2 经验积累

```yaml
记录失败案例:
  - 记录失败场景
  - 记录成功恢复方案
  - 更新备选策略
  - 优化工具选择

持续优化:
  - 分析失败模式
  - 改进备选方案
  - 完善降级策略
  - 提升恢复效率
```

---

## 六、工具组合模式

### 6.1 链式调用模式

```yaml
定义: 多个工具按顺序执行，前一个工具的输出作为后一个工具的输入

模式结构:
  Tool1 → Tool2 → Tool3 → Result

常见链式组合:
  文件搜索链:
    Glob (找文件) → Read (读内容) → Grep (搜索内容)
    
  代码分析链:
    SearchCodebase (语义搜索) → Read (读取代码) → 分析
    
  项目探索链:
    LS (浏览目录) → Glob (找文件) → Read (读文件)

最佳实践:
  - 每步验证前一步结果
  - 设置中间检查点
  - 处理链中断情况
  - 记录完整调用链
```

### 6.2 并行调用模式

```yaml
定义: 多个工具同时执行，结果汇总处理

模式结构:
  Tool1 ─┐
  Tool2 ─┼→ 汇总 → Result
  Tool3 ─┘

常见并行组合:
  多文件读取:
    Read(file1) ─┐
    Read(file2) ─┼→ 整合分析
    Read(file3) ─┘
    
  多维度搜索:
    Grep(模式1) ─┐
    Grep(模式2) ─┼→ 结果合并
    Glob(模式3) ─┘

最佳实践:
  - 确保操作相互独立
  - 设置超时限制
  - 处理部分失败
  - 合并结果去重
```

### 6.3 条件调用模式

```yaml
定义: 根据条件选择不同的工具执行路径

模式结构:
  条件判断 → True路径 → Result
           → False路径 → Result

常见条件组合:
  文件存在判断:
    if 文件存在: Read(文件)
    else: Glob(搜索) → Read(找到的文件)
    
  文件大小判断:
    if 文件小: Read(完整读取)
    else: Grep(部分搜索)
    
  搜索结果判断:
    if Grep有结果: 使用结果
    else: SearchCodebase(语义搜索)

最佳实践:
  - 明确判断条件
  - 提供默认路径
  - 记录路径选择
  - 处理异常分支
```

### 6.4 重试调用模式

```yaml
定义: 工具失败后自动重试，可配置重试策略

模式结构:
  执行 → 失败 → 重试(策略) → 成功/最终失败

重试策略:
  固定重试:
    次数: 3次
    间隔: 1秒
    
  指数退避:
    次数: 5次
    间隔: 1s → 2s → 4s → 8s → 16s
    
  条件重试:
    条件: 特定错误类型
    策略: 针对性重试

常见重试场景:
  网络请求:
    错误: 超时、连接失败
    重试: 指数退避
    
  文件操作:
    错误: 文件锁定
    重试: 固定间隔
    
  搜索操作:
    错误: 无结果
    重试: 放宽条件

最佳实践:
  - 设置最大重试次数
  - 区分可重试错误
  - 记录重试日志
  - 避免无限重试
```

### 6.5 组合模式示例

```yaml
场景: 分析项目中的Agent实现

链式 + 条件组合:
  Step 1: Glob("**/*agent*.py") → 找到Agent文件
  Step 2: if 文件存在:
            Read(file) → 读取内容
          else:
            SearchCodebase("agent implementation") → 语义搜索
  Step 3: Grep("class.*Agent") → 提取类定义
  Step 4: 分析继承关系

并行 + 链式组合:
  并行执行:
    - Glob("**/chapter4/*.py") → chapter4文件
    - Glob("**/chapter7/*.py") → chapter7文件
  链式处理:
    → Read(每个文件) → Grep("class") → 汇总类列表

重试 + 降级组合:
  尝试: Read(file)
  失败重试: Read(file, retry=3)
  最终降级: Grep(file, pattern) → 部分内容
```

---

## 七、工具调用监控

### 7.1 监控指标

```yaml
调用统计:
  - 调用次数
  - 成功次数
  - 失败次数
  - 平均耗时

性能指标:
  - 响应时间分布
  - P50/P90/P99延迟
  - 超时率
  - 重试率

错误统计:
  - 错误类型分布
  - 错误频率
  - 错误影响范围
  - 恢复成功率
```

### 7.2 性能优化建议

```yaml
工具选择优化:
  - 优先使用快速工具
  - 避免重复调用
  - 合并相似请求
  - 使用缓存结果

参数优化:
  - 限制结果数量
  - 使用精确模式
  - 设置合理超时
  - 分批处理大量数据

调用策略优化:
  - 并行化独立操作
  - 缓存中间结果
  - 提前终止无效路径
  - 使用增量处理
```
