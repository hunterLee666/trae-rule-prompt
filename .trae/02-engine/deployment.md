---
name: Deployment Rules
description: 部署发布规则 - 部署策略、发布流程、环境管理
version: "8.6"
priority: 85
alwaysApply: true
---

# 部署发布规则

> **"部署有道，发布有术。"**

## 一、部署策略

### 1.1 部署模式

```yaml
蓝绿部署:
  原理: 两套环境，一键切换
  优点: 快速回滚，零停机
  缺点: 资源占用高
  适用: 关键服务

金丝雀发布:
  原理: 逐步放量，渐进发布
  优点: 风险可控，问题早发现
  缺点: 发布时间长
  适用: 大规模服务

滚动更新:
  原理: 逐个更新，逐步替换
  优点: 资源利用率高
  缺点: 回滚较慢
  适用: 无状态服务

A/B测试:
  原理: 同时运行多版本
  优点: 数据驱动决策
  缺点: 实现复杂
  适用: 功能验证
```

### 1.2 部署原则

```yaml
部署原则:
  原子性: 部署要么成功，要么失败
  可重复: 相同输入产生相同结果
  可追溯: 记录所有部署历史
  可回滚: 支持快速回滚

部署检查:
  部署前:
    - 代码审查通过
    - 测试全部通过
    - 配置检查完成
    
  部署中:
    - 健康检查
    - 性能监控
    - 错误告警
    
  部署后:
    - 功能验证
    - 性能验证
    - 用户反馈
```

---

## 二、发布流程

### 2.1 发布阶段

```yaml
发布阶段:
  开发阶段:
    - 功能开发
    - 单元测试
    - 代码审查
    
  测试阶段:
    - 集成测试
    - 性能测试
    - 安全测试
    
  预发布阶段:
    - 预发布环境验证
    - 灰度测试
    - 回归测试
    
  生产阶段:
    - 生产环境部署
    - 监控告警
    - 用户验证
```

### 2.2 发布检查清单

```yaml
发布前检查:
  代码:
    - [ ] 代码已合并到发布分支
    - [ ] 所有测试通过
    - [ ] 代码审查完成
    - [ ] 无已知严重Bug
    
  配置:
    - [ ] 配置文件已更新
    - [ ] 环境变量已配置
    - [ ] 密钥已更新
    - [ ] 数据库迁移脚本已准备
    
  依赖:
    - [ ] 依赖版本已锁定
    - [ ] 第三方服务可用
    - [ ] 资源配额充足

发布后检查:
  功能:
    - [ ] 核心功能正常
    - [ ] API响应正常
    - [ ] 数据一致性
    
  性能:
    - [ ] 响应时间正常
    - [ ] 资源使用正常
    - [ ] 无性能退化
    
  监控:
    - [ ] 监控指标正常
    - [ ] 告警规则生效
    - [ ] 日志正常输出
```

### 2.3 版本管理

```yaml
语义化版本:
  格式: MAJOR.MINOR.PATCH
  
  MAJOR: 不兼容的API变更
  MINOR: 向后兼容的功能新增
  PATCH: 向后兼容的问题修复

预发布版本:
  Alpha: 内部测试版本
  Beta: 公开测试版本
  RC: 发布候选版本
  
  示例: 1.0.0-alpha.1, 1.0.0-beta.2, 1.0.0-rc.1

版本标签:
  latest: 最新稳定版本
  stable: 稳定版本
  dev: 开发版本
  特定版本: v1.0.0
```

---

## 三、环境管理

### 3.1 环境类型

```yaml
开发环境:
  用途: 日常开发
  配置: 本地配置
  数据: 测试数据
  访问: 开发人员

测试环境:
  用途: 功能测试
  配置: 测试配置
  数据: 测试数据
  访问: 测试人员

预发布环境:
  用途: 发布前验证
  配置: 生产配置
  数据: 脱敏生产数据
  访问: 测试人员

生产环境:
  用途: 线上服务
  配置: 生产配置
  数据: 真实数据
  访问: 所有用户
```

### 3.2 环境配置

```yaml
配置管理:
  配置分离: 代码与配置分离
  环境变量: 使用环境变量
  配置中心: 集中管理配置
  配置加密: 敏感配置加密

配置模板:
  基础配置: 所有环境共享
  环境配置: 环境特定配置
  覆盖规则: 环境配置覆盖基础配置
```

### 3.3 环境隔离

```yaml
网络隔离:
  开发环境: 内网
  测试环境: 内网
  预发布环境: 内网
  生产环境: 公网

数据隔离:
  开发环境: 独立数据库
  测试环境: 独立数据库
  预发布环境: 独立数据库
  生产环境: 生产数据库

资源隔离:
  开发环境: 共享资源
  测试环境: 共享资源
  预发布环境: 独立资源
  生产环境: 独立资源
```

---

## 四、CI/CD流水线

### 4.1 流水线结构

```yaml
流水线阶段:
  Source:
    - 代码检出
    - 分支检测
    - 变更检测
    
  Build:
    - 依赖安装
    - 代码编译
    - 构建产物
    
  Test:
    - 单元测试
    - 集成测试
    - 代码质量检查
    
  Package:
    - 打包镜像
    - 推送仓库
    - 版本标记
    
  Deploy:
    - 环境部署
    - 健康检查
    - 通知发布
```

### 4.2 流水线配置

```yaml
GitHub Actions示例:
  name: CI/CD Pipeline
  
  on:
    push:
      branches: [main, develop]
    pull_request:
      branches: [main]
  
  jobs:
    build:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v3
        - name: Setup Node
          uses: actions/setup-node@v3
          with:
            node-version: '18'
        - run: npm ci
        - run: npm run build
        - run: npm test
        
    deploy:
      needs: build
      if: github.ref == 'refs/heads/main'
      runs-on: ubuntu-latest
      steps:
        - name: Deploy to Production
          run: |
            echo "Deploying to production..."
```

### 4.3 流水线最佳实践

```yaml
流水线原则:
  快速反馈: 构建时间<10分钟
  失败快速: 失败时立即停止
  并行执行: 独立任务并行
  缓存优化: 缓存依赖和构建产物

流水线安全:
  密钥管理: 使用密钥管理服务
  权限控制: 最小权限原则
  审计日志: 记录所有操作
  分支保护: 保护重要分支
```

---

## 五、回滚策略

### 5.1 回滚场景

```yaml
触发回滚:
  自动触发:
    - 健康检查失败
    - 错误率超过阈值
    - 性能严重下降
    
  手动触发:
    - 发现严重Bug
    - 用户反馈问题
    - 安全漏洞

回滚时机:
  立即回滚: 严重问题
  计划回滚: 非紧急问题
  修复后回滚: 需要数据修复
```

### 5.2 回滚流程

```yaml
回滚步骤:
  1. 确认回滚决策
     - 评估问题严重程度
     - 确认回滚版本
     - 通知相关人员
     
  2. 执行回滚操作
     - 切换到旧版本
     - 验证服务状态
     - 检查数据一致性
     
  3. 回滚后处理
     - 监控系统状态
     - 记录回滚原因
     - 安排问题修复
```

### 5.3 回滚检查

```yaml
回滚验证:
  功能验证:
    - 核心功能正常
    - API响应正常
    - 数据完整性
    
  性能验证:
    - 响应时间恢复
    - 资源使用正常
    - 无异常告警
    
  用户验证:
    - 用户访问正常
    - 无用户投诉
    - 业务指标恢复
```

---

## 六、监控告警

### 6.1 监控指标

```yaml
应用监控:
  - 请求量 (QPS/RPS)
  - 响应时间 (P50/P90/P99)
  - 错误率
  - 可用性

系统监控:
  - CPU使用率
  - 内存使用率
  - 磁盘使用率
  - 网络流量

业务监控:
  - 用户活跃度
  - 转化率
  - 订单量
  - 收入
```

### 6.2 告警规则

```yaml
告警级别:
  P0 - 紧急:
    条件: 服务不可用
    通知: 电话 + 短信 + 邮件
    响应: 5分钟内
    
  P1 - 严重:
    条件: 错误率 > 5%
    通知: 短信 + 邮件
    响应: 15分钟内
    
  P2 - 警告:
    条件: 性能下降
    通知: 邮件
    响应: 1小时内
    
  P3 - 提示:
    条件: 资源使用高
    通知: 邮件
    响应: 24小时内
```

### 6.3 发布监控

```yaml
发布监控:
  实时监控:
    - 请求量变化
    - 错误率变化
    - 响应时间变化
    
  对比监控:
    - 新旧版本对比
    - 发布前后对比
    - 环境间对比
    
  异常检测:
    - 自动异常检测
    - 趋势预测
    - 阈值告警
```
