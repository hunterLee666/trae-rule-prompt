---
name: TRAE Security Layer
description: 安全隐私层 - 隐私保护、数据安全、访问控制、审计合规
version: "7.0"
priority: 100
alwaysApply: true
---

# 05-security/ 安全隐私层

## 职责范围

安全隐私层是TRAE系统的"守护者"，负责：
- **隐私架构** - 隐私优先设计、数据最小化
- **数据保护** - 敏感数据识别、加密、脱敏
- **访问控制** - 权限管理、身份验证
- **审计日志** - 操作记录、合规追踪
- **安全模式** - 安全最佳实践、威胁防护

---

## 核心组件

### 1. 隐私架构 (privacy-architecture.md)
基于OpenCode的隐私优先设计：

```yaml
隐私原则:
  1. 本地优先处理:
     - 尽可能在本地处理数据
     - 使用本地模型 (Ollama, LM Studio)
     - 最小化网络请求
     
  2. 数据最小化:
     - 只收集必要数据
     - 只发送必要代码片段
     - 敏感信息脱敏
     
  3. 用户控制:
     - 用户决定数据共享范围
     - 可配置隐私级别
     - 随时撤销授权
     
  4. 透明度:
     - 清晰说明数据流向
     - 公开数据处理政策
     - 提供审计能力
```

**隐私级别**：
- **strict** - 仅本地处理，无云端传输
- **balanced** - 云端处理前询问用户
- **relaxed** - 自动选择最优方案

### 2. 数据保护 (data-protection.md)
敏感数据全生命周期保护：

```yaml
敏感数据类型:
  Credentials:
    - API密钥
    - 密码
    - 私钥
    - 访问令牌
    
  Personal:
    - 个人身份信息(PII)
    - 联系信息
    - 地理位置
    
  Proprietary:
    - 商业机密
    - 算法实现
    - 专有配置

保护措施:
  Detection:
    - 文件名模式匹配 (.env, *.key)
    - 内容扫描 (正则表达式)
    - 权限检查
    
  Redaction:
    - API_KEY=***
    - password: [REDACTED]
    - token: <HIDDEN>
    
  Encryption:
    - 传输中加密 (TLS)
    - 静态加密 (AES)
    - 密钥管理
    
  Access:
    - 最小权限原则
    - 访问审批流程
    - 定期权限审查
```

### 3. 访问控制 (access-control.md)
权限管理和身份验证：

```yaml
认证机制:
  - 令牌认证 (API Token)
  - OAuth集成
  - 单点登录 (SSO)
  
授权模型:
  RBAC (基于角色的访问控制):
    - admin: 完全访问
    - developer: 代码读写
    - viewer: 只读访问
    
  ABAC (基于属性的访问控制):
    - 项目归属
    - 数据敏感度
    - 用户角色
    
权限检查点:
  - 文件访问前
  - 命令执行前
  - 数据发送前
  - 配置修改前
```

### 4. 审计日志 (audit-logging.md)
完整的操作追踪：

```yaml
审计事件:
  - 文件访问
  - 命令执行
  - 数据发送
  - 配置变更
  - 权限变更

日志格式:
  timestamp: ISO 8601
  event_type: 事件类型
  user_id: 用户标识
  resource: 访问资源
  action: 执行动作
  result: 成功/失败
  context: 上下文信息

日志保留:
  - 常规日志: 30天
  - 安全事件: 1年
  - 合规日志: 按法规要求
  
日志分析:
  - 异常检测
  - 访问模式分析
  - 合规报告生成
```

### 5. 安全模式
安全最佳实践与威胁防护：

**安全原则：**
```yaml
防御深度:
  - 多层防护
  - 纵深防御
  - 无单点故障

最小权限:
  - 只授予必要权限
  - 按需授权
  - 定期审查

安全默认:
  - 默认拒绝
  - 显式授权
  - 安全配置

失败安全:
  - 失败时安全降级
  - 不暴露敏感信息
  - 可恢复设计
```

**常见威胁与防护：**
```yaml
注入攻击:
  类型: SQL注入、命令注入、代码注入
  防护: 输入验证、参数化查询、白名单过滤

跨站脚本 (XSS):
  类型: 存储型、反射型、DOM型
  防护: 输出编码、内容安全策略、输入验证

路径遍历:
  类型: 目录遍历、文件包含
  防护: 路径规范化、白名单验证、权限检查

敏感数据泄露:
  类型: 日志泄露、错误信息泄露、配置泄露
  防护: 数据脱敏、错误处理、配置保护
```

**安全模式：**
```yaml
输入验证模式:
  白名单验证: 只允许已知安全输入、正则表达式匹配、类型检查
  输入清理: 移除危险字符、编码转换、长度限制

输出编码模式:
  上下文编码: HTML编码、URL编码、JavaScript编码
  内容安全策略: CSP头部、资源白名单、内联脚本禁止

访问控制模式:
  权限检查: 每次访问检查、集中权限管理、审计日志
  会话管理: 安全会话ID、会话超时、会话固定防护
```

**安全响应流程：**
```yaml
1. 发现威胁: 监控告警、用户报告、安全审计
2. 评估影响: 影响范围、严重程度、紧急程度
3. 制定方案: 临时缓解、根本修复、预防措施
4. 实施修复: 应用补丁、配置调整、代码修改
5. 验证效果: 安全测试、回归测试、监控验证
```

### 6. 合规要求 (compliance.md)
法规和标准合规：

```yaml
合规框架:
  GDPR:
    - 数据处理记录
    - 访问权
    - 删除权
    - 数据可携带权
    
  SOC 2:
    - 访问控制
    - 审计追踪
    - 数据加密
    - 事件响应
    
  HIPAA:
    - 健康数据保护
    - 访问审计
    - 数据传输安全
    
  PCI DSS:
    - 支付数据保护
    - 网络安全
    - 漏洞管理

合规检查:
  - 定期合规审计
  - 自动化合规扫描
  - 合规报告生成
  - 违规告警机制
```

---

## 快速参考

```yaml
安全检查清单:
  □ 隐私级别已配置
  □ 敏感数据已脱敏
  □ 使用本地模型(如可能)
  □ 访问权限已验证
  □ 操作已记录日志
  □ 传输已加密
  
敏感文件模式:
  .env, *.key, *.pem, credentials
  
隐私级别:
  strict    → 仅本地
  balanced  → 询问用户
  relaxed   → 自动处理
```

---

## 文件清单

| 文件 | 说明 | 来源 |
|------|------|------|
| README.md | 本文件（含安全模式） | 新建 |
| privacy-architecture.md | 隐私架构 | opencode-study/07-privacy-architecture.md |
| data-protection.md | 数据保护 | 新建 |
| access-control.md | 访问控制 | 新建 |
| audit-logging.md | 审计日志 | 新建 |
| compliance.md | 合规要求 | 新建 |

---

## 相关层

- ↑ 调用: SYSTEM.md (全局治理)
- → 协作: 所有其他层（安全横切关注点）
- → 报告: 审计日志输出

---

## 安全检查点

在以下时机触发安全检查：
1. **启动时** - 隐私级别检查
2. **文件访问前** - 敏感文件检测
3. **数据发送前** - 数据脱敏检查
4. **命令执行前** - 权限验证
5. **配置变更时** - 安全审查

---

> **核心原则**: "安全不是功能，而是基础。"
