---
name: Workflow Modes
description: Plan/Build双模式工作流 - 规划与执行分离
version: "7.0"
priority: 95
alwaysApply: true
---

# 工作流模式

> **"先规划后执行，安全可控。"**

## 一、双模式架构

```yaml
Plan Mode (规划模式):
  特点: 只读、分析、规划
  触发: 分析、设计、计划类请求
  操作: 读取文件、分析代码、制定方案
  输出: 计划文档、分析报告、设计方案
  
Build Mode (执行模式):
  特点: 读写、实施、验证
  触发: 实现、修复、创建类请求
  操作: 修改文件、执行命令、运行测试
  输出: 代码变更、测试结果、验证报告
```

## 二、Plan模式详解

### 2.1 触发条件

```yaml
关键词触发:
  - "分析..."
  - "设计..."
  - "计划..."
  - "如何..."
  - "评估..."
  - "审查..."
  - "比较..."

场景触发:
  - 需要理解现有代码
  - 需要制定实施方案
  - 需要评估多个选项
  - 需要分析问题根因
```

### 2.2 Plan模式操作

```yaml
允许操作:
  ✅ read - 读取文件
  ✅ glob - 查找文件
  ✅ grep - 搜索内容
  ✅ lsp_* - LSP分析
  ✅ websearch - 网络搜索
  ✅ webfetch - 获取网页

禁止操作:
  ❌ write - 写入文件
  ❌ edit - 编辑文件
  ❌ delete - 删除文件
  ❌ bash (修改性) - 修改性命令
```

### 2.3 Plan模式输出

```markdown
## 📋 分析报告

### 1. 现状分析
[当前状态描述]

### 2. 问题识别
[发现的问题]

### 3. 解决方案
[建议的方案]

### 4. 实施计划
| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | ... | ... |

### 5. 风险评估
[潜在风险和应对措施]
```

## 三、Build模式详解

### 3.1 触发条件

```yaml
关键词触发:
  - "实现..."
  - "修复..."
  - "添加..."
  - "创建..."
  - "删除..."
  - "重构..."
  - "更新..."

场景触发:
  - 需要修改代码
  - 需要创建文件
  - 需要执行命令
  - 需要运行测试
```

### 3.2 Build模式操作

```yaml
允许操作:
  ✅ read - 读取文件
  ✅ write - 写入文件
  ✅ edit - 编辑文件
  ✅ delete - 删除文件
  ✅ glob - 查找文件
  ✅ grep - 搜索内容
  ✅ lsp_* - LSP分析
  ✅ bash - 执行命令
  ✅ websearch - 网络搜索
  ✅ webfetch - 获取网页

安全检查:
  - 文件修改前确认
  - 命令执行前审查
  - 敏感操作需用户确认
```

### 3.3 Build模式流程

```yaml
标准流程:
  1. 理解需求
     - 确认用户意图
     - 识别关键约束
     
  2. 分析现有代码
     - 读取相关文件
     - 理解代码结构
     
  3. 设计变更
     - 制定修改方案
     - 评估影响范围
     
  4. 实施变更
     - 执行文件修改
     - 运行验证命令
     
  5. 验证结果
     - 运行测试
     - 检查诊断
     - 确认功能正常
     
  6. 总结报告
     - 变更摘要
     - 测试结果
     - 后续建议
```

## 四、模式切换

### 4.1 Plan → Build

```yaml
触发条件:
  - 用户确认执行计划
  - 用户说"开始执行"
  - 用户说"按计划实施"

切换流程:
  1. 确认计划已审核
  2. 切换到Build模式
  3. 按计划执行操作
  4. 验证执行结果
```

### 4.2 Build → Plan

```yaml
触发条件:
  - 执行遇到问题需要重新规划
  - 用户要求暂停执行
  - 发现计划需要调整

切换流程:
  1. 保存当前进度
  2. 分析问题原因
  3. 制定新方案
  4. 等待用户确认
```

## 五、安全控制

```yaml
Plan模式安全:
  - 只读操作，无风险
  - 可自由探索代码库
  - 输出仅供参考

Build模式安全:
  - 文件修改前备份
  - 敏感操作需确认
  - 执行后验证结果
  - 支持回滚操作

确认级别:
  Level 1 (自动): 
    - 读取文件
    - 搜索内容
    - 分析代码
    
  Level 2 (静默执行):
    - 创建新文件
    - 添加注释
    - 格式化代码
    
  Level 3 (需确认):
    - 修改现有代码
    - 删除文件
    - 执行系统命令
    
  Level 4 (需明确授权):
    - 修改配置文件
    - 执行危险命令
    - 访问敏感数据
```

## 六、最佳实践

```yaml
Plan模式最佳实践:
  1. 充分分析后再提出方案
  2. 提供多个可选方案
  3. 评估每个方案的优缺点
  4. 给出明确的推荐建议

Build模式最佳实践:
  1. 小步快跑，频繁验证
  2. 每次修改后运行测试
  3. 保持代码可回滚
  4. 记录所有变更

模式切换最佳实践:
  1. Plan完成后等待用户确认
  2. Build遇到问题及时切换回Plan
  3. 保持上下文连贯
  4. 记录决策过程
```

## 七、边界检测规则

### 7.1 边界模糊场景

```yaml
模糊场景类型:
  分析+修改混合:
    示例: "分析并优化这个函数"
    特点: 既有分析需求，又有修改需求
    
  评估+实施混合:
    示例: "评估性能问题并修复"
    特点: 需要先评估后实施
    
  设计+创建混合:
    示例: "设计并实现一个新功能"
    特点: 设计和实现连续进行
```

### 7.2 边界检测算法

```yaml
检测流程:
  Step 1: 关键词权重计算
    Plan关键词: 分析, 设计, 计划, 如何, 评估, 审查, 比较
    Build关键词: 实现, 修复, 添加, 创建, 删除, 重构, 更新
    
  Step 2: 权重比较
    if Plan权重 > Build权重 + 2:
      → Plan模式
    elif Build权重 > Plan权重 + 2:
      → Build模式
    else:
      → 边界模糊，需要确认
      
  Step 3: 场景判断
    if 包含"并"连接词:
      → 检测为多阶段任务
      → 按顺序执行不同模式
      
  Step 4: 用户确认
    if 边界模糊:
      → 询问用户选择模式
      → 或默认使用安全模式(Plan)
```

### 7.3 多阶段任务处理

```yaml
处理策略:
  策略1: 顺序执行
    规则: 先Plan后Build
    示例: "分析并优化" → Plan分析 → 用户确认 → Build优化
    
  策略2: 拆分执行
    规则: 拆分为独立任务
    示例: "设计并实现" → 任务1:设计 → 任务2:实现
    
  策略3: 用户选择
    规则: 让用户决定模式
    示例: "优化这个函数" → 询问:仅分析还是直接修改?
```

### 7.4 边界决策矩阵

| 场景 | Plan权重 | Build权重 | 推荐模式 | 处理方式 |
|-----|---------|----------|---------|---------|
| "分析代码" | 10 | 0 | Plan | 直接执行 |
| "修复bug" | 0 | 10 | Build | 直接执行 |
| "分析并修复" | 5 | 5 | 模糊 | 顺序执行 |
| "优化性能" | 3 | 4 | 模糊 | 询问用户 |
| "重构代码" | 2 | 8 | Build | 直接执行 |
| "设计方案" | 10 | 0 | Plan | 直接执行 |
| "设计并实现" | 5 | 5 | 模糊 | 顺序执行 |

### 7.5 安全默认规则

```yaml
边界模糊时的安全策略:
  默认模式: Plan模式
  原因: 
    - Plan模式只读，无风险
    - 用户可以在Plan后确认执行
    - 避免意外修改
  
  确认提示模板:
    "检测到您的请求可能涉及代码修改。
    请选择操作模式：
    1. 仅分析 - 我将分析问题并提供方案
    2. 直接执行 - 我将分析并实施修改
    
    请回复 1 或 2"
```

## 八、模式状态管理

### 8.1 状态记录

```yaml
状态信息:
  current_mode: Plan | Build
  mode_history: 
    - { mode: Plan, timestamp: "...", reason: "..." }
    - { mode: Build, timestamp: "...", reason: "..." }
  pending_actions: []
  confirmed_plans: []
```

### 8.2 状态持久化

```yaml
持久化内容:
  - 当前模式
  - 模式切换历史
  - 待执行计划
  - 已确认计划
  
存储位置:
  - .trae/state/workflow-state.yaml
  - 会话上下文
```
