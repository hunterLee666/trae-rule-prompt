---
name: Context Check
description: 上下文检查触发器 - 对话过长时强制执行
version: "1.0"
priority: 90
alwaysApply: true
trigger: "on_long_conversation"
---

# 上下文检查触发器

> **⚠️ 强制规则：对话过长时必须执行上下文管理**

---

## 一、触发条件

```yaml
触发场景:
  - 对话轮次 > 20轮
  - 单次对话内容 > 10000字
  - 重复提及相同信息 > 3次
  - 用户询问"之前说过什么"
  - 信息出现冲突或矛盾
  - 需要回顾早期对话内容

不触发场景:
  - 短对话（< 10轮）
  - 单一主题对话
  - 信息量小的对话
```

---

## 二、上下文层级

```yaml
层级定义 (从高到低优先级):

  Level 5 - 会话上下文:
    来源: 当前对话历史
    内容: 用户问题、AI响应、工具结果
    生命周期: 会话期间
    优先级: 最高

  Level 4 - 文件上下文:
    来源: 文件内注释
    内容: 文件级规则、特殊说明
    生命周期: 文件存在
    优先级: 高

  Level 3 - 目录上下文:
    来源: 目录AGENTS.md
    内容: 目录级规则、模块约定
    生命周期: 目录存在
    优先级: 中

  Level 2 - 项目上下文:
    来源: 项目根AGENTS.md
    内容: 项目级规则、全局约定
    生命周期: 项目存在
    优先级: 低

  Level 1 - 系统上下文:
    来源: 系统内置知识
    内容: 通用规则、最佳实践
    生命周期: 永久
    优先级: 最低
```

---

## 三、信息优先级

### 3.1 保留优先级

```yaml
P0 - 必须保留:
  - 用户明确的需求和目标
  - 关键决策和结论
  - 重要约束条件
  - 错误和修复记录
  - 当前任务状态

P1 - 应该保留:
  - 技术方案选择依据
  - 代码修改原因
  - 用户偏好设置
  - 重要上下文信息

P2 - 可以压缩:
  - 详细的代码片段
  - 完整的文件内容
  - 重复的讨论内容
  - 中间过程记录

P3 - 可以丢弃:
  - 已解决的问题
  - 无关的闲聊
  - 过时的信息
  - 冗余的描述
```

### 3.2 压缩策略

```yaml
压缩方法:

  摘要压缩:
    原文: "用户要求实现登录功能，包括用户名密码登录、
          手机验证码登录、第三方登录（微信、QQ），
          还需要记住密码和忘记密码功能..."
    压缩: "需求: 登录功能（密码/验证码/第三方登录）"

  结构化压缩:
    原文: 大段对话记录
    压缩: 
      - 决策1: 使用JWT认证
      - 决策2: 密码使用bcrypt加密
      - 决策3: 支持微信和QQ登录

  引用压缩:
    原文: 完整的代码文件
    压缩: "参见文件: /path/to/file.py (已修改)"
```

---

## 四、上下文管理动作

### 4.1 定期检查

```yaml
检查频率:
  - 每10轮对话检查一次
  - 检测信息冗余
  - 识别关键信息
  - 评估压缩需求

检查内容:
  □ 是否有重复信息？
  □ 是否有过时信息？
  □ 是否有冲突信息？
  □ 关键信息是否保留？
```

### 4.2 压缩执行

```yaml
压缩流程:
  1. 识别可压缩内容
  2. 提取关键信息
  3. 生成摘要
  4. 替换原文
  5. 验证信息完整性

压缩输出:
  "📋 上下文摘要:
   - 任务: 实现用户登录功能
   - 决策: JWT认证 + bcrypt加密
   - 进度: 后端API已完成，前端进行中
   - 待办: 测试编写、文档更新"
```

---

## 五、快速检查卡

```
┌─────────────────────────────────────────────┐
│           上下文管理速查表                   │
├─────────────────────────────────────────────┤
│                                             │
│  触发检查:                                   │
│    □ 对话 > 20轮？                          │
│    □ 内容 > 10000字？                       │
│    □ 重复信息 > 3次？                       │
│                                             │
│  保留优先级:                                 │
│    P0 必须保留: 需求/决策/约束/状态          │
│    P1 应该保留: 方案依据/偏好/上下文         │
│    P2 可以压缩: 代码/文件/过程               │
│    P3 可以丢弃: 已解决/无关/过时             │
│                                             │
│  压缩方法:                                   │
│    □ 摘要压缩 (提取要点)                    │
│    □ 结构化压缩 (列表化)                    │
│    □ 引用压缩 (文件引用)                    │
│                                             │
└─────────────────────────────────────────────┘
```

---

## 六、违规示例

```yaml
❌ 错误示例:
  对话30轮后:
  - 保留所有历史信息
  - 重复讨论已解决的问题
  - 忘记用户早期提出的需求

✅ 正确示例:
  对话30轮后:
  - 主动压缩上下文
  - 输出摘要:
    "📋 当前进度摘要:
     - 需求: 实现登录功能
     - 已完成: 后端API、数据库设计
     - 进行中: 前端页面
     - 待办: 测试、文档"
```

---

**记住**：上下文不是越多越好，关键信息才是核心！
