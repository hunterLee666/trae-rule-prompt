---
name: Tool Fallback Check
description: 工具调用检查点 - 每次工具调用前/后强制执行
version: "1.0"
priority: 95
alwaysApply: true
trigger: "before_after_tool_call"
---

# 工具调用检查点

> **⚠️ 强制规则：在每次工具调用前后必须执行检查**

---

## 一、调用前检查

```yaml
检查清单:

  文件操作 (Read/Write/Edit/Delete):
    □ 路径是否正确？
    □ 文件是否存在？（读取/编辑/删除前）
    □ 是否有备选路径？
    □ 权限是否足够？
    
  搜索操作 (Grep/Glob/SearchCodebase):
    □ 搜索模式是否合理？
    □ 范围是否适当？
    □ 是否有备选搜索策略？
    
  命令执行 (RunCommand):
    □ 命令是否安全？
    □ 是否需要用户确认？
    □ 失败后是否有备选方案？
    
  网络操作 (WebSearch/WebFetch):
    □ 是否真的需要网络请求？
    □ 本地是否有替代信息源？
    □ 超时设置是否合理？
```

---

## 二、失败处理策略

### 2.1 文件操作失败

```yaml
文件不存在:
  错误行为: 直接报错终止
  正确行为:
    1. 使用Glob搜索相似文件: Glob("pattern": "*filename*")
    2. 检查路径大小写
    3. 询问用户确认正确路径
    4. 提供创建文件选项（如适用）

示例:
  用户请求: "读取 config.py"
  文件不存在时:
    ❌ 错误: "File not found: config.py"
    ✅ 正确: 
      "未找到 config.py，发现相似文件：
       - config_dev.py
       - config_prod.py
       请确认要读取哪个文件？"

文件权限不足:
  处理:
    1. 尝试只读模式
    2. 通知用户权限问题
    3. 提供权限修改建议

文件过大:
  处理:
    1. 分段读取（offset + limit）
    2. 只读取关键部分
    3. 使用Grep搜索特定内容
```

### 2.2 搜索操作失败

```yaml
无搜索结果:
  错误行为: 返回空结果
  正确行为:
    1. 放宽搜索条件（去掉部分限制）
    2. 尝试相似模式（模糊匹配）
    3. 扩大搜索范围
    4. 使用SearchCodebase替代Grep

示例:
  Grep("pattern": "getUserById") 无结果时:
    → 尝试 Grep("pattern": "get.*User.*Id", "-i": true)
    → 尝试 SearchCodebase("information_request": "查找用户ID相关的函数")

搜索结果过多:
  处理:
    1. 添加更多过滤条件
    2. 缩小搜索范围（指定目录）
    3. 使用更精确的模式
```

### 2.3 命令执行失败

```yaml
命令执行错误:
  处理:
    1. 分析错误信息
    2. 检查命令语法
    3. 检查依赖是否安装
    4. 提供修复建议

示例:
  npm install 失败:
    → 检查 package.json 是否存在
    → 检查网络连接
    → 尝试使用缓存或镜像
```

### 2.4 网络操作失败

```yaml
网络请求失败:
  处理:
    1. 检查是否可以使用本地信息
    2. 重试机制（最多2次）
    3. 提供离线替代方案

示例:
  WebSearch 超时:
    → 检查本地文档
    → 使用已有知识回答
    → 告知用户无法获取最新信息
```

---

## 三、工具组合策略

```yaml
优先级策略:
  1. SearchCodebase > Grep > Glob (代码搜索)
  2. Read分段 > Read全量 (大文件)
  3. 本地信息 > 网络搜索 (信息获取)

组合模式:
  定位文件:
    Glob → Read → Grep
  
  理解代码:
    SearchCodebase → Read → 分析
  
  搜索内容:
    Grep无结果 → SearchCodebase → 放宽条件
```

---

## 四、快速检查卡

```
┌─────────────────────────────────────────────┐
│           工具调用检查速查表                 │
├─────────────────────────────────────────────┤
│                                             │
│  调用前:                                     │
│    □ 路径/参数是否正确？                     │
│    □ 是否有备选方案？                        │
│    □ 失败后如何处理？                        │
│                                             │
│  调用失败:                                   │
│    □ 分析错误原因                            │
│    □ 尝试备选方案                            │
│    □ 通知用户并提供建议                      │
│                                             │
│  常用备选:                                   │
│    Read失败 → Glob搜索 → 询问用户            │
│    Grep无结果 → SearchCodebase → 放宽条件    │
│    WebSearch失败 → 本地知识 → 告知限制       │
│                                             │
└─────────────────────────────────────────────┘
```

---

## 五、违规示例

```yaml
❌ 错误示例:
  - Read失败后直接报错终止
  - Grep无结果后返回空
  - 不尝试备选方案就放弃

✅ 正确示例:
  - Read失败 → Glob搜索 → 询问用户
  - Grep无结果 → SearchCodebase → 放宽条件
  - 始终提供备选方案和用户选择
```

---

**记住**：每次工具调用都要考虑失败场景和备选方案！
