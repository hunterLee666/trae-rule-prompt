---
name: Testing Check
description: 测试检查触发器 - 代码实现后强制执行
version: "1.0"
priority: 90
alwaysApply: true
trigger: "after_code_implementation"
---

# 测试检查触发器

> **⚠️ 强制规则：代码实现后必须检查测试覆盖**

---

## 一、触发条件

```yaml
触发场景:
  - 新功能实现完成
  - Bug修复完成
  - 代码重构完成
  - API接口实现完成
  - 用户明确要求测试

不触发场景:
  - 简单配置修改
  - 文档更新
  - 纯查询任务
  - 用户明确跳过测试
```

---

## 二、测试金字塔

### 2.1 测试类型分布

```yaml
测试金字塔:
  
  单元测试 (70%):
    范围: 单个函数/类/模块
    速度: 快 (毫秒级)
    成本: 低
    目的: 验证代码逻辑正确性
    示例: 测试函数输入输出
  
  集成测试 (20%):
    范围: 模块间交互
    速度: 中 (秒级)
    成本: 中
    目的: 验证模块集成正确性
    示例: 测试API与数据库交互
  
  端到端测试 (10%):
    范围: 完整用户流程
    速度: 慢 (分钟级)
    成本: 高
    目的: 验证系统整体功能
    示例: 测试用户登录到下单流程
```

### 2.2 测试覆盖要求

```yaml
覆盖率标准:
  
  核心业务逻辑:
    单元测试: 必须，覆盖率 > 90%
    集成测试: 必须，覆盖主要流程
    E2E测试: 推荐，覆盖关键路径
  
  API接口:
    单元测试: 必须，覆盖率 > 80%
    集成测试: 必须，覆盖所有端点
    E2E测试: 推荐，覆盖主要场景
  
  工具函数:
    单元测试: 必须，覆盖率 > 95%
    集成测试: 可选
    E2E测试: 不需要
  
  配置代码:
    单元测试: 可选
    集成测试: 可选
    E2E测试: 不需要
```

---

## 三、测试检查清单

### 3.1 单元测试检查

```yaml
检查项:
  
  功能覆盖:
    □ 正常流程测试
    □ 边界条件测试
    □ 异常情况测试
    □ 空值/空字符串测试
  
  测试质量:
    □ 测试命名清晰
    □ 测试独立运行
    □ 测试可重复执行
    □ 断言充分明确
  
  示例:
    def test_get_user_by_id_success():
        """测试正常获取用户"""
        user = get_user_by_id(1)
        assert user is not None
        assert user.id == 1
    
    def test_get_user_by_id_not_found():
        """测试用户不存在"""
        user = get_user_by_id(999)
        assert user is None
    
    def test_get_user_by_id_invalid():
        """测试无效ID"""
        with pytest.raises(ValueError):
            get_user_by_id(-1)
```

### 3.2 集成测试检查

```yaml
检查项:
  
  接口测试:
    □ 所有API端点覆盖
    □ 请求参数验证
    □ 响应格式验证
    □ 错误码验证
  
  数据库测试:
    □ CRUD操作测试
    □ 事务测试
    □ 并发测试
  
  示例:
    def test_create_user_api(client):
        """测试创建用户API"""
        response = client.post('/api/users', json={
            'name': 'test',
            'email': 'test@example.com'
        })
        assert response.status_code == 201
        assert response.json['id'] is not None
```

---

## 四、测试输出模板

```markdown
## 🧪 测试检查报告

### 测试覆盖情况

| 类型 | 要求 | 实际 | 状态 |
|-----|------|------|------|
| 单元测试 | > 80% | 85% | ✅ |
| 集成测试 | 主要流程 | 已覆盖 | ✅ |
| E2E测试 | 关键路径 | 待补充 | ⚠️ |

### 单元测试清单

| 测试项 | 状态 | 说明 |
|-------|------|------|
| 正常流程 | ✅ | 已覆盖 |
| 边界条件 | ✅ | 已覆盖 |
| 异常情况 | ✅ | 已覆盖 |
| 空值处理 | ❌ | 待补充 |

### 待补充测试

- [ ] 空值/空字符串测试
- [ ] 并发场景测试
- [ ] E2E关键路径测试

### 测试命令

```bash
# 运行单元测试
pytest tests/unit -v

# 运行集成测试
pytest tests/integration -v

# 查看覆盖率
pytest --cov=src --cov-report=html
```
```

---

## 五、快速检查卡

```
┌─────────────────────────────────────────────┐
│           测试检查速查表                     │
├─────────────────────────────────────────────┤
│                                             │
│  触发检查:                                   │
│    □ 功能实现完成？                          │
│    □ Bug修复完成？                           │
│    □ 代码重构完成？                          │
│                                             │
│  单元测试 (70%):                            │
│    □ 正常流程测试？                          │
│    □ 边界条件测试？                          │
│    □ 异常情况测试？                          │
│    □ 覆盖率 > 80%？                         │
│                                             │
│  集成测试 (20%):                            │
│    □ API端点覆盖？                           │
│    □ 数据库操作测试？                        │
│                                             │
│  E2E测试 (10%):                             │
│    □ 关键路径测试？                          │
│                                             │
└─────────────────────────────────────────────┘
```

---

## 六、违规示例

```yaml
❌ 错误示例:
  实现功能后:
  - 不编写测试
  - 只写一个简单测试
  - 测试覆盖率 < 50%

✅ 正确示例:
  实现功能后:
  - 编写单元测试（正常/边界/异常）
  - 编写集成测试
  - 覆盖率 > 80%
  - 输出测试检查报告
```

---

**记住**：没有测试的代码是不完整的代码！
