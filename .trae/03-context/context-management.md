---
name: Context Management
description: 上下文管理 - AGENTS.md分层加载、上下文压缩、优先级排序
version: "10.1"
priority: 90
alwaysApply: true
---

# 上下文管理

> **"分层加载，按需获取。"**

## 一、上下文层级

```yaml
层级定义 (从高到低优先级):
  Level 5: Conversation Context
    来源: 当前对话历史
    内容: 用户问题、AI响应、工具结果
    生命周期: 会话期间
    
  Level 4: File Context
    来源: 文件内注释
    内容: 文件级规则、特殊说明
    生命周期: 文件存在
    
  Level 3: Directory Context
    来源: 目录AGENTS.md
    内容: 目录级规则、模块约定
    生命周期: 目录存在
    
  Level 2: Project Context
    来源: 项目根AGENTS.md
    内容: 项目级规则、全局约定
    生命周期: 项目存在
    
  Level 1: System Context
    来源: 系统内置知识
    内容: 通用规则、最佳实践
    生命周期: 永久
```

## 二、加载策略

```yaml
加载原则:
  按需加载:
    - 只加载相关上下文
    - 避免加载无关内容
    - 优化内存使用
    
  增量加载:
    - 先加载高层上下文
    - 根据需要加载低层
    - 合并上下文信息
    
  缓存复用:
    - 缓存已加载上下文
    - 检测上下文变化
    - 智能更新缓存

加载时机:
  - 会话开始时
  - 切换目录时
  - 访问新文件时
  - 上下文更新时
```

## 三、上下文合并

```yaml
合并规则:
  冲突处理:
    - 高层级优先
    - 明确规则优先
    - 最新规则优先
    
  合并策略:
    - 规则叠加
    - 规则覆盖
    - 规则补充

合并示例:
  Level 1: "使用4空格缩进"
  Level 2: "Python使用4空格，JS使用2空格"
  Level 3: "本项目统一使用2空格"
  
  最终结果: "使用2空格缩进"
```

## 四、AGENTS.md格式

```yaml
文件结构:
  ---
  name: 上下文名称
  description: 上下文描述
  version: 版本号
  priority: 优先级
  ---
  
  # 规则内容
  
  ## 编码规范
  [具体规范]
  
  ## 项目约定
  [具体约定]
  
  ## 特殊说明
  [特殊说明]

最佳实践:
  - 保持简洁
  - 明确优先级
  - 定期更新
  - 版本控制
```

## 五、上下文更新

```yaml
更新触发:
  - 文件修改
  - 目录变更
  - 配置更新
  - 手动刷新

更新策略:
  增量更新:
    - 只更新变化部分
    - 保持其他部分不变
    
  全量更新:
    - 重新加载全部上下文
    - 适用于重大变更

更新通知:
  - 通知相关组件
  - 更新缓存状态
  - 记录更新日志
```

---

## 六、上下文压缩

### 6.1 压缩策略

```yaml
压缩时机:
  - 上下文超过token限制
  - 历史信息过多
  - 响应效率下降

压缩方法:
  摘要压缩:
    原理: 将长文本压缩为摘要
    适用: 历史对话、文档内容
    效果: 保留核心信息
    
  选择性保留:
    原理: 保留关键信息，删除冗余
    适用: 重复内容、次要信息
    效果: 减少上下文长度
    
  分层压缩:
    原理: 按重要性分层压缩
    适用: 多层级信息
    效果: 平衡信息量和效率
```

### 6.2 压缩规则

```yaml
信息保留优先级:
  P0 - 必须保留:
    - 当前任务目标
    - 关键决策点
    - 用户明确要求
    
  P1 - 重要保留:
    - 核心上下文
    - 关键约束条件
    - 重要中间结果
    
  P2 - 可压缩:
    - 详细过程描述
    - 重复信息
    - 次要细节
    
  P3 - 可删除:
    - 无关历史
    - 已完成任务
    - 过时信息

压缩比例:
  目标: 压缩至原长度的30-50%
  方法:
    - 提取关键句
    - 合并相似内容
    - 删除重复信息
```

### 6.3 压缩示例

```yaml
原始上下文 (1000字):
  "在上一轮对话中，我们讨论了Agent的实现方式。
  首先分析了ReAct模式的工作原理，它包含思考、行动、
  观察三个步骤。然后我们实现了MyReActAgent类，
  继承自ReActAgent基类。在实现过程中遇到了一些问题，
  比如工具调用失败的处理，我们通过添加重试机制解决了
  这个问题。最后我们测试了Agent的功能，发现它可以
  正确处理多步推理任务..."

压缩后上下文 (300字):
  "上轮讨论: Agent实现
  - ReAct模式: 思考→行动→观察
  - 实现: MyReActAgent继承ReActAgent
  - 问题: 工具调用失败 → 解决: 重试机制
  - 结果: 多步推理任务正常"
```

---

## 七、上下文优先级排序

### 7.1 优先级评估

```yaml
评估维度:
  相关性:
    - 与当前任务的相关程度
    - 信息对决策的影响
    - 用户关注程度
    
  时效性:
    - 信息的创建时间
    - 最后更新时间
    - 有效期
    
  重要性:
    - 对任务完成的影响
    - 错误后果严重程度
    - 用户价值
    
  确定性:
    - 信息的可靠程度
    - 来源可信度
    - 验证状态
```

### 7.2 排序算法

```yaml
综合评分:
  Score = w1 * 相关性 + w2 * 时效性 + w3 * 重要性 + w4 * 确定性
  
  权重建议:
    w1 (相关性): 0.4
    w2 (时效性): 0.2
    w3 (重要性): 0.3
    w4 (确定性): 0.1

排序策略:
  Top-K选择:
    - 选择得分最高的K条信息
    - K根据上下文容量确定
    
  阈值过滤:
    - 过滤得分低于阈值的信息
    - 阈值根据任务复杂度调整
    
  分层保留:
    - 每个层级保留一定比例
    - 确保信息多样性
```

### 7.3 动态调整

```yaml
任务阶段调整:
  开始阶段:
    - 优先加载任务定义
    - 保留用户原始需求
    
  执行阶段:
    - 优先加载执行上下文
    - 保留中间结果
    
  完成阶段:
    - 优先加载验证规则
    - 保留最终结果

用户反馈调整:
  正面反馈:
    - 保持当前优先级
    
  负面反馈:
    - 调整优先级权重
    - 重新排序上下文
```

---

## 八、上下文监控

### 8.1 监控指标

```yaml
容量监控:
  - 当前上下文长度
  - 各层级占比
  - 增长趋势

效率监控:
  - 加载时间
  - 查询响应时间
  - 压缩效果

质量监控:
  - 信息命中率
  - 冗余度
  - 过时信息比例
```

### 8.2 告警规则

```yaml
容量告警:
  - 上下文长度 > 80%限制: 警告
  - 上下文长度 > 95%限制: 严重

效率告警:
  - 加载时间 > 2秒: 警告
  - 响应时间 > 5秒: 严重

质量告警:
  - 信息命中率 < 50%: 警告
  - 冗余度 > 30%: 警告
```
